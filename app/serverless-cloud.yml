service: formularios-api
frameworkVersion: "3"

plugins:
  - serverless-esbuild

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-east-1'}
  memorySize: 512
  timeout: 30

  environment:
    FORMULARIOS_TABLE: formularios-${self:provider.stage}
    STAGE: ${self:provider.stage}

  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:Scan
            - dynamodb:Query
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/formularios-${self:provider.stage}
            - arn:aws:dynamodb:${self:provider.region}:*:table/formularios-${self:provider.stage}/index/*

functions: ${file(config/serverless/functions.cloud.yaml)}

custom:
  esbuild:
    bundle: true
    minify: true
    sourcemap: false
    exclude:
      - '@aws-sdk/*'
    target: node20
    platform: node
